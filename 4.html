<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航管理后台</title>
    <style>
        /* 基本样式，略 */
    </style>
</head>
<body>
    <div class="container">
        <h1>导航管理后台</h1>

        <!-- 显示数据 -->
        <div id="websites-list">
            <!-- 动态显示网站列表 -->
        </div>

        <!-- 添加网站 -->
        <form id="add-form">
            <input type="text" id="site-name" placeholder="网站名称" required />
            <input type="url" id="site-url" placeholder="网站URL" required />
            <button type="submit">添加网站</button>
        </form>

        <!-- 配置GitHub信息 -->
        <div class="github-config">
            <h2>GitHub 配置</h2>
            <input type="text" id="repo-url" placeholder="GitHub 仓库地址" />
            <input type="password" id="github-token" placeholder="GitHub 访问令牌" />
            <button id="save-config">保存配置</button>
        </div>
    </div>

    <script>
        let githubConfig = { repo: '', token: '' };
        let websites = [];  // 网站列表

        // 从GitHub获取数据
        async function loadData() {
            const response = await fetch('data.json');  // 这里假设数据存储在GitHub上的`data.json`
            const data = await response.json();
            websites = data.websites;
            renderWebsites();
        }

        // 渲染网站列表
        function renderWebsites() {
            const list = document.getElementById('websites-list');
            list.innerHTML = '';
            websites.forEach((site, index) => {
                const siteElement = document.createElement('div');
                siteElement.innerHTML = `
                    <p><strong>${site.name}</strong>: ${site.url} 
                    <button onclick="deleteWebsite(${index})">删除</button>
                    <button onclick="editWebsite(${index})">编辑</button></p>
                `;
                list.appendChild(siteElement);
            });
        }

        // 添加新网站
        async function addWebsite(event) {
            event.preventDefault();
            const name = document.getElementById('site-name').value;
            const url = document.getElementById('site-url').value;
            websites.push({ name, url });
            renderWebsites();
            await saveToGitHub();
        }

        // 删除网站
        function deleteWebsite(index) {
            if (confirm('确定删除这个网站吗？')) {
                websites.splice(index, 1);
                renderWebsites();
                saveToGitHub();
            }
        }

        // 编辑网站
        function editWebsite(index) {
            const newName = prompt('请输入新名称:', websites[index].name);
            const newUrl = prompt('请输入新网址:', websites[index].url);
            if (newName && newUrl) {
                websites[index].name = newName;
                websites[index].url = newUrl;
                renderWebsites();
                saveToGitHub();
            }
        }

        // 保存到GitHub
        async function saveToGitHub() {
            if (!githubConfig.repo || !githubConfig.token) {
                alert('请先配置GitHub仓库');
                return;
            }

            try {
                const content = JSON.stringify({ websites }, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));

                // 获取当前文件SHA
                let sha = '';
                try {
                    const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/data.json`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`
                        }
                    });
                    const fileInfo = await response.json();
                    sha = fileInfo.sha;
                } catch (error) {
                    console.log('文件不存在，准备创建新文件');
                }

                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: '更新导航数据',
                        content: encodedContent,
                        sha: sha || undefined
                    })
                });

                if (response.ok) {
                    alert('数据已保存到GitHub');
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                alert('保存到GitHub失败');
            }
        }

        // 保存GitHub配置
        document.getElementById('save-config').addEventListener('click', () => {
            githubConfig.repo = document.getElementById('repo-url').value;
            githubConfig.token = document.getElementById('github-token').value;
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            alert('GitHub 配置已保存');
        });

        // 初始化加载
        document.addEventListener('DOMContentLoaded', () => {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                document.getElementById('repo-url').value = githubConfig.repo || '';
                document.getElementById('github-token').value = githubConfig.token || '';
            }
            loadData();

            // 添加网站表单事件
            document.getElementById('add-form').addEventListener('submit', addWebsite);
        });
    </script>
</body>
</html>